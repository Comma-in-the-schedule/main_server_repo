name: Deploy Spring Boot with Docker Compose

on:
  push:
    branches: [feature]
  pull_request:
    branches: [feature]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK ì„¤ì • (ë¹Œë“œìš©)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env)
      - name: Create .env file
        run: |
          cat <<EOF > .env
          MYSQL_HOST=${{ secrets.MYSQL_HOST }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EOF

      # 4. Spring Boot ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ ì ìš©)
      - name: Build Spring Boot application
        run: |
          export $(grep -v '^#' .env | xargs)  # âœ… í™˜ê²½ë³€ìˆ˜ ì ìš©
          ./gradlew clean build --no-daemon --build-cache --parallel --stacktrace

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë³´ì•ˆ ê°•í™”)
      - name: Build Docker Image
        run: |
          docker build -t spring-boot-app:${{ github.sha }} .

      # 6. Docker Compose íŒŒì¼ ë° ì´ë¯¸ì§€ Oracle Cloudë¡œ ì „ì†¡ (âš¡ ê°œì„ : rsync ì‚¬ìš©)
      - name: Sync files to Oracle Cloud
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avz --delete
          path: .
          remote_path: "~/app/"
          remote_host: ${{ secrets.VM_HOST }}
          remote_user: ${{ secrets.VM_USER }}
          remote_key: ${{ secrets.VM_SSH_PRIVATE_KEY }}

      - name: Save & Transfer Docker Image to Oracle Cloud
        run: |
          docker save spring-boot-app:${{ github.sha }} | gzip > spring-boot-app.tar.gz

      - name: Upload Docker Image to Oracle Cloud
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          source: "spring-boot-app.tar.gz"
          target: "~/docker-images/"

      # 7. Oracle Cloudì—ì„œ Docker Compose ì‹¤í–‰ (âš¡ ìµœì í™”)
      - name: Deploy Docker Compose
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          timeout: 200ms
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            cd ~/app

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            sudo docker-compose down --remove-orphans || true
            sudo docker stop $(sudo docker ps -aq) || true
            sudo docker rm -f $(sudo docker ps -aq) || true
            sudo docker network prune -f || true

            # ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ (âš¡ ë¶ˆí•„ìš”í•œ ì „ì²´ prune ë°©ì§€)
            echo "ğŸ—‘ ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            sudo docker rmi -f $(sudo docker images -q) || true

            # ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë¡œë“œ
            echo "ğŸš€ ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
            gunzip -c ~/docker-images/spring-boot-app.tar.gz | docker load

            # ğŸ“Œ í™˜ê²½ë³€ìˆ˜ .env íŒŒì¼ ìƒì„±
            echo "ğŸ“Œ .env íŒŒì¼ ìƒì„± ì¤‘..."
            cat <<EOF > .env
            MYSQL_HOST=${{ secrets.MYSQL_HOST }}
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            MYSQL_USER=${{ secrets.MYSQL_USER }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            MAIL_HOST=${{ secrets.MAIL_HOST }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOF

            # í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…)
            echo "ğŸ“Œ ìƒì„±ëœ .env íŒŒì¼ ë‚´ìš©:"
            cat .env

            # Docker Compose ì‹¤í–‰ (âš¡ `--no-deps` ì¶”ê°€í•˜ì—¬ ì˜ì¡´ì„± ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
            echo "ğŸš€ Docker Compose ì‹¤í–‰ ì¤‘..."
            sudo docker-compose --env-file .env up -d --no-deps --build

            # ì‹¤í–‰ëœ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“œ ì‹¤í–‰ëœ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
            sudo docker ps -a