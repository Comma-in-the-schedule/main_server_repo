name: Deploy Spring Boot and MySQL to Docker Hub

on:
  push:
    branches: [feature]
  pull_request:
    branches: [feature]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK ì„¤ì • (Gradle ë¹Œë“œìš©)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ï¸âƒ£ Spring Boot ë¹Œë“œ (Gradle)
      - name: Build Spring Boot application
        run: |
          ./gradlew clean build --no-daemon --stacktrace

      # 4ï¸âƒ£ Docker ë¡œê·¸ì¸ (Docker Hub)
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 5ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ & íƒœê¹… (Spring Boot)
      - name: Build and Tag Spring Boot Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }} .
          docker tag ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest

      # 6ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ & íƒœê¹… (MySQL)
      - name: Build and Tag MySQL Docker Image
        run: |
          docker pull mysql:8.0
          docker tag mysql:8.0 ${{ secrets.DOCKER_USERNAME }}/mysql:latest

      # 7ï¸âƒ£ Docker Hubì— Spring Boot & MySQL ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push Docker Images to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/mysql:latest

      # 8ï¸âƒ£ ì›ê²© ì„œë²„ì—ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (SSH)
      - name: Deploy to Remote Server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ & ì‚­ì œ
            sudo docker stop spring-boot-app mysql-db || true
            sudo docker rm -f spring-boot-app mysql-db || true
            
            # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/mysql:latest
            
            # ë„¤íŠ¸ì›Œí¬ê°€ ì—†ì„ ê²½ìš°ì—ë§Œ ìƒì„±
            if ! sudo docker network ls | grep -q "my-network"; then
            sudo docker network create my-network
            fi
  
  
            # MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d --name mysql-db \
              --network my-network \
              -e MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_PASSWORD }} \
              -e MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }} \
              -p 3306:3306 \
              --restart always \
              ${{ secrets.DOCKER_USERNAME }}/mysql:latest
            
            # Spring Boot ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d --name spring-boot-app \
              --network my-network \
              -e SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/${{ secrets.MYSQL_DATABASE }} \
              -e SPRING_DATASOURCE_USERNAME=root \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.MYSQL_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e MAIL_HOST=${{ secrets.MAIL_HOST }} \
              -e MAIL_USERNAME=${{ secrets.MAIL_USERNAME }} \
              -e MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }} \
              
              -p 8080:8080 \
              --restart always \
              ${{ secrets.DOCKER_USERNAME }}/spring-boot-app:latest